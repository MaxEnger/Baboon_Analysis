---
title: "Papio anubis SDM: Olive Baboon"
date: "10/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## To Do:
1. Make side-by-side plots of input variables
2. Clean up documentation
3. Make this reproducible or try to have download.file function to retrieve data

## Papio anubis SDM: Olive Baboon
### Importing libraries
```{r}
library(raster)
library(rgdal)
library(maps)
library(mapdata)
library(dismo)
library(rJava)
library(maptools)
library(jsonlite)
library(dplyr)
library(sf)
library(readr)
```

### Retrieving current and future environmental data from WorldClim (http://worldclim.org, Hijmans et al. 2005).GetData is from the raster package.
```{r}
currentEnv <-  getData("worldclim", var = "bio", res = 2.5) # The variables are bioclimatic and the resolution is 2.5 arc seconds.
futureEnv <-  getData('CMIP5', var = 'bio', res = 2.5, rcp = 85, model = 'HE', year = 70) # CMIP5 refers to the phase 5 Coupled Model Intercomparison Project. RCP8.5 is used. Prediction is for the year 2070.
names(futureEnv) = names(currentEnv) # names function used to set the name of an object.
```

### Limit to a smaller set of bioclimatic predictors. Excluding the bioclimatic variables 2, 3, 4, 10, 11, 13, 14, and 15.
```{r}
currentEnv <- currentEnv %>% dropLayer(. , c("bio2", "bio3", "bio4", "bio10", "bio11", "bio13", "bio14", "bio15"))
futureEnv <- futureEnv %>% dropLayer(. , c("bio2", "bio3", "bio4", "bio10", "bio11", "bio13", "bio14", "bio15"))
```

# Remaining Bioclimatic Predictors
# BIO1 = Annual Mean Temperature
# BIO5 = Max Temperature of Warmest Month
# BIO6 = Min Temperature of Coldest Month
# BIO7 = Temperature Annual Range (BIO5-BIO6)
# BIO8 = Mean Temperature of Wettest Quarter
# BIO9 = Mean Temperature of Driest Quarter
# BIO12 = Annual Precipitation
# BIO16 = Precipitation of Wettest Quarter
# BIO17 = Precipitation of Driest Quarter
# BIO18 = Precipitation of Warmest Quarter
# BIO19 = Precipitation of Coldest Quarter

### Obtain species data from Global Biodiversity Information Facility (GBIF)
```{r}
olive <- gbif('Papio', 'anubis') # gbif is under the package, dismo to access data directly using the scientific name of the species.
olive <- subset(olive, !is.na(lon) & !is.na(lat)) # remove all observations without lat and long (! means 'not')
olivedups <- duplicated(olive[, c("lon", "lat")]) # eliminate duplicate locations
olive <- olive[!olivedups, ] # brackets indicate the position of items in a vector
```

### Making a map extending 1 degree around the species observations (Preliminary Map of Species)
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
# load and read in data
data(wrld_simpl) # loads polygon world dataset, wrld_simpl
study_area <- readOGR("./data", layer = "StudyAreaPoly")  
study_area_sf <- study_area %>% st_as_sf(coords = c("LAT", "LON"), st_crs(wrld_simpl))

# plot 
plot(wrld_simpl, xlim = c(min(olive$lon)-1, max(olive$lon)+1), ylim = c(min(olive$lat)-1, max(olive$lat)+1), axes = TRUE, col = "grey", main = " Species Distribution of Papio anubis", cex.main = 1.75)
plot(st_geometry(study_area_sf), col = "grey40", add = TRUE)
points(olive$lon, olive$lat, col = "yellow", pch = 20, cex = 0.75)
```

### Conserve the species distribution to Africa or its 'native' range
```{r}
olive <- olive[olive$lon < 45 & olive$lat > -15 , ]
```

## Adding new variables
### Elevation
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
# test with sample raster data
dem <- raster("inst/extdata/dem_2.tif")
```

### EVI - Vegetation Index
```{r}
EVI_hom <- raster("V:/Commons/Baboon/SDM_data/Homogeneity_01_05_1km_uint16.tif")
```

### Mask
```{r}
rcl = matrix(c(-279,0,1,1,320,1), ncol=3, byrow=TRUE)
mask <- reclassify(x =  currentEnv$bio1, rcl = rcl)
```

### Crop the Geographic Extent to a region (10 degree buffer around species)
```{r}
# define the spatial extent of the model
model.extent <- extent(min(olive$lon)-10, max(olive$lon)+10, min(olive$lat)-10, max(olive$lat)+10)

# define current and future env. RasterStacks
modelEnv = crop(currentEnv, model.extent)
modelFutureEnv = crop(futureEnv, model.extent)

# mask crop and resample
mask = crop(mask, model.extent)
mask_resample <- resample(x= mask, y = modelEnv) 

# crop elevation to the same extent and resample
dem = crop(dem, model.extent)
dem_resample <- resample(x= dem, y = modelEnv) 
demEnv <- mask_resample * dem_resample

# crop EVI variables to the same extent
EVI_hom = crop(EVI_hom, model.extent)
EVI_hom_rescale <- EVI_hom/10000
EVI_hom_resample <- resample(x= EVI_hom_rescale, y = modelEnv)
EVI_homEnv <- mask_resample * EVI_hom_resample

# add elevation and EVI data to raster stacks for model
modelEnv <- addLayer(modelEnv, demEnv)
modelEnv <- addLayer(modelEnv, EVI_homEnv)

modelFutureEnv <- addLayer(modelFutureEnv, demEnv)
modelFutureEnv <- addLayer(modelFutureEnv, EVI_homEnv)
```

### Plot of the Annual Mean Temperature (bio1 variable)
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(modelEnv[["bio1"]]/10, main="Annual Mean Temperature")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.2)
```

### Plot of the Future (2070) Annual Mean Temperature (bio1 variable)
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(modelFutureEnv[["bio1"]]/10, main="Future Annual Mean Temperature")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.2)
```

### Plot Elevation
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(demEnv, main="Elevation")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.2)
```

### Plot EVI - homogeneity
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(EVI_homEnv, main="EVI - homogeneity")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.2)
```

## SDM Construction and Assessment - cross-validation
### randomly withhold 20% of observations and use the 80% as training data.
```{r}
oliveocc = cbind.data.frame(olive$lon, olive$lat) # make a data frame of the lat & lon for the model
fold <- kfold(oliveocc, k = 5) # add an index that makes five random groups of species observations. Under dismo package.
olivetest <- oliveocc[fold == 1, ] # hold one fifth as testing data
olivetrain <- oliveocc[fold != 1, ] # hold four firths as training data
```

## Fit the SDM using Maximum Entropy (Maxent) algorithm
### This tires to define the combination of env. responses that best predicts the occurrence of the species.
```{r}
olive.me <- maxent(modelEnv, olivetrain) # using only training data
```

## Model visualization and Evaluation
### Compare the relative importance of different predictor variables in the model.
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(olive.me)
```

### See the response of species occurrence to variation in climatic conditions.
```{r}
response(olive.me)
```

### Generate the predicted values for every cell in the region
```{r}
olive.pred <- predict(olive.me, modelEnv)
```

### Map the predicted values and superimpose tem onto the original locations.
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(olive.pred, main = "Predicted Suitability")
map('worldHires', fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.2)
```

## Generate and Evaluate the AUC for the model

### Create background points for pseudoabsences.
```{r}
bg <- randomPoints(modelEnv, 1000)
```

### Evaluate using the test data as presences against pseudoabsences.
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
e1 <- evaluate(olive.me, p = olivetest, a = bg, x = modelEnv)
plot(e1, 'ROC')
```

## Projecting Responses to Climate Change
### Use the 2070 climate estimates to predic the habitat suitability using the model.
```{r}
olive.2070 = predict(olive.me, modelFutureEnv)
```

### Map the predicted values and superimpose the current distribution of observations.
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
plot(olive.2070, main = "Predicted Future Suitability")
map('worldHires', fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.2)
```

### Map the predicted change with positive values representing regions that are better suited for hemlock and negative for areas that represent decline in habitat quality.
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
olive.change = olive.2070-olive.pred
plot(olive.change, main = "Predicted Change in Suitability")
map('worldHires', fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.2)
```

### Histogram of the predicted change in habitat quality.
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
oliveChangePoints = raster::extract(olive.change, oliveocc)
hist(oliveChangePoints, main = "")
abline(v = 0, col = "red")
```

### Export Raster
```{r, eval = FASLE}
writeRaster(olive.pred, "V:/Commons/Baboon/SDM_data/output/olive_suitability_final.tif", overwrite = FALSE)
writeRaster(olive.2070, "V:/Commons/Baboon/SDM_data/output/olive_future_suit_final.tif", overwrite = FALSE)
```

### Maps for Final Report
#### Species Observation Map
```{r, fig.height = 4, fig.width =6, fig.align = 'center'}
par(mfrow=c(1,1))
plot(wrld_simpl, xlim = c(min(olive$lon)-1, max(olive$lon)+1), ylim = c(min(olive$lat)-1, max(olive$lat)+1), axes = TRUE, col = "grey", main = " Species Distribution of Papio anubis", cex.main = 1.75)
plot(st_geometry(study_area_sf), col = "grey40", add = TRUE)
points(olive$lon, olive$lat, col = "yellow", pch = 20, cex = 0.75)
```

#### Plot of Key Variables
````{r}
par(mfrow=c(2,2))
plot(modelEnv[["bio1"]]/10, main="Annual Mean Temperature")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.4)

plot(modelFutureEnv[["bio1"]]/10, main="Future Annual Mean Temperature")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.4)

plot(demEnv, main="Elevation")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.4)

plot(EVI_homEnv, main="EVI - homogeneity")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill=FALSE, add=TRUE)
points(olive$lon, olive$lat, pch="+", cex=0.4)
```

#### Plot Results
```{r}
par(mfrow=c(1,2))
plot(olive.pred, main = "Predicted Suitability")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.4)

plot(olive.change, main = "Predicted Change in Suitability")
map('worldHires',xlim=c(min(olive$lon)-10,max(olive$lon)+10), ylim=c(min(olive$lat)-10,max(olive$lat)+10), fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.4)
```

```{r}
par(mfrow=c(1,3))
plot(olive.pred, main = "Predicted Suitability")
map('worldHires', fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.4)

plot(olive.2070, main = "Predicted Future Suitability")
map('worldHires', fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.4)

olive.change = olive.2070-olive.pred
plot(olive.change, main = "Predicted Change in Suitability")
map('worldHires', fill = FALSE, add = TRUE)
points(olive$lon, olive$lat, pch = "+", cex = 0.4)
```

# maps for report 2
```{r}
olive_sf <- st_as_sf(olive, coords = c("lon", "lat"), crs = 4269)
olive_sf <- olive_sf %>% st_transform(., st_crs(demEnv))
olive_sp <- as(olive_sf, 'Spatial')
poly <- st_read("C:/Users/Caroline/Documents/Professional/Clark Labs/Global_Countries/countries.shp")
poly_sf <- st_as_sf(poly, coords = "geometry", crs = 4269)
poly_sf <- poly_sf %>% st_transform(., st_crs(demEnv))
poly_sp <- as(poly_sf, 'Spatial')
poly_sp = crop(poly_sp, model.extent)
```

```{r}
library(lattice)
library(rasterVis)
library(GISTools) 
library(viridisLite)
library(sp)
library(ggsn)
library(prettymapr)
library(ggspatial)
```

```{r}
col = viridis(100)
par(mfrow=c(2,2))
p1 <- levelplot(modelEnv[["bio1"]]/10,
                margin = FALSE,
                xlab = "",
                ylab = "",
                scales=list(draw = FALSE),
                main = "Annual Mean Temperature", 
                col.regions = col,
                par.settings= list(panel.background = list(col = "grey")),
                colorkey = list(axis.line = list(col = "white"), 
                           axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

#tmp <- layer()
#layout = c(north.arrow(xb=15.75, yb=43.25, len=0.05, lab="N"), layout.scale.bar()),

p2 <- levelplot(modelFutureEnv[["bio1"]]/10,
          margin = FALSE,
          xlab = "",
          ylab = "",
          scales=list(draw = FALSE),
          main = "Future Annual Mean Temperature",
          col.regions = col,
          par.settings= list(panel.background = list(col = "grey")),
          colorkey = list(axis.line = list(col = "white"), 
                    axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

p3 <- levelplot(demEnv,
          margin = FALSE,
          xlab = "",
          ylab = "",
          scales=list(draw = FALSE),
          main = "Elevation",
          col.regions = rev(col),
          par.settings= list(panel.background = list(col = "grey")),
          colorkey = list(axis.line = list(col = "white"), 
                     axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

p4 <- levelplot(EVI_homEnv,
          margin = FALSE,
          xlab = "",
          ylab = "",
          scales=list(draw = FALSE),
          main = "EVI - homogeneity",
          col.regions = col,
          par.settings= list(panel.background = list(col = "grey")),
          colorkey = list(axis.line = list(col = "white"), 
                     axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

cowplot::plot_grid(p1, p2, p3, p4, nrow = 2, ncol = 2, labels = "AUTO") +
  annotation_scale(location = "bl", width_hint = .4, plot_unit = 'km', mapping = aes(unit_category = "metric"),
                   pad_x = unit(0.15, "in"), pad_y = unit(0.15, "in")) +
  annotation_north_arrow(location = "bl", which_north = "true", 
                         pad_x = unit(4.1, "in"), pad_y = unit(0, "in"),
                         style = north_arrow_fancy_orienteering)

#prettymapr::addnortharrow(pos = "topright", padin = c(0.15, 0.15), scale = 1, lwd = 1, border = "black", cols = c("white", "black"),
#text.col = "black")
```
#tmap::tm_compass(position = c("left", "bottom")) 
#tm_scale_bar(position = c("left", "bottom"))

#+ GISTools::north.arrow(xb=-20, yb=-20, len=0.07, lab="N", col="black",cex.lab = 0.9) 
#north2(map,x=0.12,y=0.90, scale=0.09, symbol=3) 
#+ ggsn::north2( ggp = .,x = 0.65, y = 0.9, scale = 0.1, symbol = 1)
#+ GISTools::north.arrow(xb=-20, yb=-20, len=0.07, lab="N", col="black",cex.lab = 0.9) + GISTools::map.scale(xc = -20, yc=-20, len=0.7, units = "km",subdiv = 5, sfcol = "white", ndivs = 3)
#map.scale(x=15.5, y=42.75, len=0.5) 
#north.arrow(xb=15.75, yb=43.25, len=0.05, lab="N")  


```{r}
par(mfrow=c(1,3))
p5 <- levelplot(olive.pred,
          margin = FALSE,
          xlab = "",
          ylab = "",
          scales=list(draw = FALSE),
          main = "Predicted Suitability",
          col.regions = rev(col),
          par.settings= list(panel.background = list(col = "grey")),
          colorkey = list(axis.line = list(col = "white"), 
                     axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

p6 <- levelplot(olive.2070,
          margin = FALSE,
          xlab = "",
          ylab = "",
          scales=list(draw = FALSE),
          main = "Predicted Future Suitability",
          col.regions = rev(col),
          discrete = TRUE,
          par.settings= list(panel.background = list(col = "grey")),
          colorkey = list(axis.line = list(col = "white"), 
                     axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

p7 <- levelplot(olive.change,
          margin = FALSE,
          xlab = "",
          ylab = "",
          scales=list(draw = FALSE),
          main = "Predicted Change in Suitability",
          col.regions = col,
          discrete = TRUE,
          par.settings= list(panel.background = list(col = "grey")),
          colorkey = list(axis.line = list(col = "white"), 
                     axis.text = list(col = "black"))) + 
  latticeExtra::layer(sp.points(olive_sp, pch =3, col = "black")) + 
  latticeExtra::layer(sp.polygons(poly_sp, col = "black"))

cowplot::plot_grid(p5, p6, p7, nrow = 1, ncol = 3, labels = "AUTO")
```

